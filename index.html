<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stock Grid Calculator by Pump (Final)</title>
  <!-- ‡πÉ‡∏ä‡πâ Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- ‡πÉ‡∏ä‡πâ Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <style>
    :root {
      /* --- Light Mode Variables --- */
      --bg-body: #f0f2f5;
      --bg-card: #ffffff;
      --text-main: #212529;
      --text-secondary: #64748b;
      --border-color: #e2e8f0;
      --input-bg: #fff;
      --input-border: #cbd5e1;
      --table-stripe: #f8fafc;
      --table-hover: #f1f5f9;
      --highlight-color: #0f172a;
      
      --color-success: #10b981; 
      --color-danger: #ef4444;  
      --color-primary: #3b82f6; 
    }

    /* --- Dark Mode Variables --- */
    body.dark-mode {
      --bg-body: #0f172a;       
      --bg-card: #1e293b;       
      --text-main: #f8fafc;     
      --text-secondary: #94a3b8;
      --border-color: #334155;  
      --input-bg: #020617;      
      --input-border: #475569;  
      --table-stripe: rgba(255,255,255,0.02);
      --table-hover: rgba(255,255,255,0.05);
      --highlight-color: #e2e8f0; 
      
      --color-success: #34d399; 
      --color-danger: #f87171;  
      --color-primary: #60a5fa; 
    }

    body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Sarabun', sans-serif; padding-bottom: 50px; transition: background-color 0.3s ease, color 0.3s ease; }
    
    .card { background-color: var(--bg-card); border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 16px; margin-bottom: 24px; transition: background-color 0.3s ease, border-color 0.3s ease; }
    
    .header-bg { 
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
      color: white; 
      padding: 40px 20px; 
      margin-bottom: 30px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      transition: background 0.5s ease;
      position: relative;
      border-bottom: 1px solid var(--border-color);
    }
    .header-bg.usd-mode {
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    }
    
    .theme-toggle-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .theme-toggle-btn:hover { background: rgba(255,255,255,0.25); transform: scale(1.05); }

    .result-box { 
      background-color: var(--bg-card); 
      border: 1px solid var(--border-color);
      border-radius: 16px; 
      padding: 20px 8px; 
      text-align: center; 
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
      height: 100%;
      transition: transform 0.2s, background-color 0.3s ease, border-color 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    .result-box:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    
    .val-highlight { 
      font-size: clamp(1.1rem, 3.5vw, 1.5rem); 
      font-weight: 700; 
      color: var(--highlight-color); 
      margin: 8px 0; 
      white-space: nowrap;
      overflow-x: auto;
      scrollbar-width: none; 
      width: 100%;
      padding: 0 4px;
    }
    .val-highlight::-webkit-scrollbar { display: none; }

    .val-negative { color: var(--color-danger) !important; }
    .val-success { color: var(--color-success) !important; }
    .val-primary { color: var(--color-primary) !important; }

    .table { color: var(--text-main); border-color: var(--border-color); margin-bottom: 0; }
    .table th { 
        background-color: var(--bg-body); 
        color: var(--text-secondary); 
        border-bottom: 2px solid var(--border-color);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }
    .table td { border-color: var(--border-color); vertical-align: middle; padding: 12px 8px; }
    
    .table-striped > tbody > tr:nth-of-type(odd) > * {
        background-color: var(--table-stripe);
        color: var(--text-main);
        box-shadow: none;
    }
    .table-hover > tbody > tr:hover > * {
        background-color: var(--table-hover);
        color: var(--text-main);
    }

    .form-label { font-weight: 500; font-size: 0.95rem; }
    .form-control, .form-select, .input-group-text {
      background-color: var(--input-bg);
      border-color: var(--input-border);
      color: var(--text-main);
      border-radius: 8px;
      padding: 10px 12px;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--color-primary);
      background-color: var(--input-bg);
      color: var(--text-main);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); 
    }
    
    body.dark-mode .input-group-text {
        background-color: var(--bg-body);
        border-color: var(--input-border);
        color: var(--text-secondary);
    }
    
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    .text-secondary { color: var(--text-secondary) !important; }
    .text-muted { color: var(--text-secondary) !important; }

    .btn-calculate {
      background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
      border: none;
      padding: 14px;
      font-weight: 600;
      letter-spacing: 0.5px;
      transition: all 0.3s;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    body.dark-mode .btn-calculate {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
        color: white;
    }
    .btn-calculate:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
      filter: brightness(1.1);
    }
    
    .input-mode-switch .btn-outline-secondary {
        color: var(--text-secondary);
        border-color: var(--input-border);
    }
    .input-mode-switch .btn-check:checked + .btn-outline-secondary {
      background-color: var(--text-main);
      color: var(--bg-card);
      border-color: var(--text-main);
      font-weight: 600;
    }
    body.dark-mode .input-mode-switch .btn-check:checked + .btn-outline-secondary {
        background-color: var(--text-secondary);
        color: var(--bg-body);
        border-color: var(--text-secondary);
    }

    .badge-custom {
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        font-weight: 500;
        background: var(--bg-body);
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .table tbody tr { animation: fadeIn 0.3s ease-out forwards; }

    /* New Toggle Switch Style for Board Lot */
    .form-check-input {
      background-color: var(--input-bg);
      border-color: var(--input-border);
    }
    .form-check-input:checked {
      background-color: var(--color-success);
      border-color: var(--color-success);
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>

<div class="header-bg text-center" id="mainHeader">
  <button class="theme-toggle-btn" onclick="toggleTheme()" title="Switch Light/Dark Mode">
    <i id="themeIcon" class="bi bi-moon-fill"></i>
  </button>
  <h2 class="fw-bold">üìà Stock Grid & Martingale</h2>
  <p class="mb-0 opacity-75">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ú‡∏ô‡πÄ‡∏ó‡∏£‡∏î‡∏´‡∏∏‡πâ‡∏ô (‡∏â‡∏ö‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏±‡πä‡∏°)</p>
</div>

<div class="container">
  <div class="row g-4">
    <!-- Input Section -->
    <div class="col-lg-4">
      <div class="card p-4 h-100">
        <h5 class="card-title mb-4 fw-bold border-bottom pb-3" style="border-color: var(--border-color) !important;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏≠‡∏£‡πå‡∏ï (Inputs)</h5>
        
        <!-- Currency Toggle -->
        <div class="mb-4">
          <label class="form-label text-secondary mb-2">‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô (Currency)</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="currencyMode" id="currTHB" value="THB" checked onchange="toggleCurrency()">
            <label class="btn btn-outline-success" for="currTHB">üáπüá≠ THB (‡∏´‡∏∏‡πâ‡∏ô‡πÑ‡∏ó‡∏¢)</label>
            
            <input type="radio" class="btn-check" name="currencyMode" id="currUSD" value="USD" onchange="toggleCurrency()">
            <label class="btn btn-outline-primary" for="currUSD">üá∫üá∏ USD (‡∏´‡∏∏‡πâ‡∏ô US)</label>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label text-secondary">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏∏‡πâ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Price)</label>
          <div class="input-group">
            <input type="number" id="startPrice" class="form-control" value="10.00" step="0.01" onchange="calculate()">
            <span class="input-group-text currency-symbol">‡∏ø</span>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label text-secondary mb-2">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏°‡πâ‡πÅ‡∏£‡∏Å‡∏î‡πâ‡∏ß‡∏¢ (Input Mode)</label>
          <div class="btn-group w-100 input-mode-switch" role="group">
            <input type="radio" class="btn-check" name="inputMode" id="modeShares" value="shares" checked onchange="toggleInputMode()">
            <label class="btn btn-outline-secondary" for="modeShares">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô (Shares)</label>
            
            <input type="radio" class="btn-check" name="inputMode" id="modeBudget" value="budget" onchange="toggleInputMode()">
            <label class="btn btn-outline-secondary" for="modeBudget">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Budget)</label>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label text-secondary" id="startInputLabel">Start Volume (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô)</label>
          <input type="number" id="startInput" class="form-control" value="100">
          <div class="form-text text-muted small mt-2" id="startInputHint">
            <i class="bi bi-info-circle"></i> ...
          </div>
          <div id="convertedShareDisplay" class="alert alert-info mt-2 p-2 small d-none" style="background-color: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.2); color: var(--color-primary);">
            ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô: <strong><span id="calculatedShares">0</span></strong> ‡∏´‡∏∏‡πâ‡∏ô
          </div>
        </div>

        <!-- NEW: Board Lot Checkbox (Visible only in THB) -->
        <div class="mb-3 d-none" id="boardLotOption">
          <div class="form-check form-switch p-0 d-flex align-items-center gap-2 rounded-3 border p-2" style="border-color: var(--border-color) !important;">
             <input class="form-check-input ms-1" type="checkbox" id="useBoardLot" onchange="calculate()">
             <label class="form-check-label text-secondary small" for="useBoardLot">‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏© Board Lot (x100)</label>
          </div>
        </div>

        <div class="mb-3">
          <div class="row">
              <div class="col-6">
                <label class="form-label text-secondary">‡πÑ‡∏°‡πâ (Orders)</label>
                <input type="number" id="orderCount" class="form-control" value="10" max="200" onchange="validateMaxOrders()">
              </div>
              <div class="col-6">
                <label class="form-label text-secondary">‡∏£‡∏∞‡∏¢‡∏∞ (Step)</label>
                <input type="number" id="priceStep" class="form-control" value="0.50" step="0.01">
              </div>
          </div>
        </div>

        <div class="mb-4">
          <label class="form-label text-secondary">Strategy (‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏á‡∏¥‡∏ô)</label>
          <select id="strategy" class="form-select">
            <option value="fixed">1. Fixed (‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡πÑ‡∏°‡πâ)</option>
            <option value="martingale">2. Classic Martingale (x2)</option>
            <option value="soft">3. Soft Martingale (x1.5)</option>
            <option value="linear">4. Linear Step (1,2,3...)</option>
            <option value="fibonacci">5. Fibonacci (1,1,2,3...)</option>
          </select>
        </div>
        
        <div class="d-grid mt-auto pt-2">
           <button class="btn btn-primary btn-calculate w-100 text-white rounded-3" onclick="calculate()">
             üöÄ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ú‡∏ô (Calculate)
           </button>
        </div>
      </div>
    </div>

    <!-- Output Section -->
    <div class="col-lg-8">
      
      <!-- Summary Cards -->
      <div class="row g-3 mb-4">
        <div class="col-6 col-lg-3">
          <div class="result-box">
            <div class="text-secondary small text-uppercase fw-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô‡∏£‡∏ß‡∏°</div>
            <div class="val-highlight" id="sumShares">0</div>
            <span class="badge-custom">Shares</span>
          </div>
        </div>
        
        <div class="col-6 col-lg-3">
          <div class="result-box">
            <div class="text-secondary small text-uppercase fw-bold">‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</div>
            <div class="val-highlight val-primary" id="totalCost">0</div>
            <span class="badge-custom" style="color: var(--color-primary); border-color: rgba(59, 130, 246, 0.3);">Total Cost</span>
          </div>
        </div>

        <div class="col-6 col-lg-3">
          <div class="result-box">
            <div class="text-secondary small text-uppercase fw-bold">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
            <div class="val-highlight val-success" id="avgPrice">0.00</div>
            <span class="badge-custom" style="color: var(--color-success); border-color: rgba(16, 185, 129, 0.3);">Avg Price</span>
          </div>
        </div>

        <div class="col-6 col-lg-3">
          <div class="result-box">
            <div class="text-secondary small text-uppercase fw-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
            <div class="val-highlight val-negative" id="maxDD">0.00</div>
            <span class="badge-custom" style="color: var(--color-danger); border-color: rgba(239, 68, 68, 0.3);">Max DD</span>
          </div>
        </div>
      </div>

      <!-- Detail Table -->
      <div class="card p-4">
        <h5 class="card-title fw-bold mb-3">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏°‡πâ‡πÄ‡∏ó‡∏£‡∏î (Trade Plan)</h5>
        <div class="table-responsive rounded-3 border" style="border-color: var(--border-color) !important;">
          <table class="table table-hover table-striped text-center text-nowrap mb-0 align-middle">
            <thead>
              <tr>
                <th class="py-3">‡πÑ‡∏°‡πâ‡∏ó‡∏µ‡πà #</th>
                <th class="py-3">‡∏£‡∏≤‡∏Ñ‡∏≤ (Price)</th>
                <th class="py-3">‡∏£‡∏∞‡∏¢‡∏∞ (Step)</th>
                <th class="py-3">‡∏´‡∏∏‡πâ‡∏ô (Vol)</th>
                <th class="py-3">‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° (Cost)</th>
                <th class="py-3">‡∏ï‡∏¥‡∏î‡∏•‡∏ö (DD)</th>
              </tr>
            </thead>
            <tbody id="resultTable">
              <!-- JS ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
              <tr><td colspan="6" class="text-muted py-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mt-3 text-end text-muted small opacity-75">
            * DD ‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡∏á‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πâ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (Worst Case)
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  window.onload = function() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('themeIcon').classList.replace('bi-moon-fill', 'bi-sun-fill');
    }
    toggleCurrency(); 
  }

  function toggleTheme() {
    const body = document.body;
    const icon = document.getElementById('themeIcon');
    body.classList.toggle('dark-mode');
    
    if (body.classList.contains('dark-mode')) {
        icon.classList.replace('bi-moon-fill', 'bi-sun-fill');
        localStorage.setItem('theme', 'dark');
    } else {
        icon.classList.replace('bi-sun-fill', 'bi-moon-fill');
        localStorage.setItem('theme', 'light');
    }
  }

  function toggleCurrency() {
    const isUSD = document.getElementById('currUSD').checked;
    const symbols = document.querySelectorAll('.currency-symbol');
    const boardLotOption = document.getElementById('boardLotOption');
    
    symbols.forEach(el => el.innerText = isUSD ? '$' : '‡∏ø');

    const header = document.getElementById('mainHeader');
    if (isUSD) {
        header.classList.add('usd-mode');
        boardLotOption.classList.add('d-none'); // Hide Board Lot option for USD
    } else {
        header.classList.remove('usd-mode');
        boardLotOption.classList.remove('d-none'); // Show for THB
    }

    const startInput = document.getElementById('startInput');
    startInput.step = isUSD ? "0.0001" : "1";

    toggleInputMode();
    calculate();
  }

  function toggleInputMode() {
    const isBudget = document.getElementById('modeBudget').checked;
    const isUSD = document.getElementById('currUSD').checked;
    const useBoardLot = document.getElementById('useBoardLot').checked && !isUSD;
    
    const label = document.getElementById('startInputLabel');
    const hint = document.getElementById('startInputHint');
    const input = document.getElementById('startInput');
    const display = document.getElementById('convertedShareDisplay');

    if (isBudget) {
      label.innerText = `Initial Budget (‡∏á‡∏ö‡πÑ‡∏°‡πâ‡πÅ‡∏£‡∏Å ${isUSD ? '$' : '‡∏ø'})`;
      input.placeholder = isUSD ? "‡πÄ‡∏ä‡πà‡∏ô 1000 $" : "‡πÄ‡∏ä‡πà‡∏ô 2000 ‡∏ø";
      
      let hintText = "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥";
      if (isUSD) hintText += " (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏®‡∏©‡∏´‡∏∏‡πâ‡∏ô)";
      else hintText += useBoardLot ? " (‡∏õ‡∏±‡∏î‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏á‡∏ï‡∏±‡∏ß 100)" : " (‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡∏ó‡∏¥‡πâ‡∏á)";
      hint.innerText = hintText;

      display.classList.remove('d-none');
    } else {
      label.innerText = "Start Volume (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)";
      input.placeholder = isUSD ? "‡πÄ‡∏ä‡πà‡∏ô 0.5 ‡∏´‡∏£‡∏∑‡∏≠ 100" : "‡πÄ‡∏ä‡πà‡∏ô 100 ‡∏´‡∏£‡∏∑‡∏≠ 1000";
      
      if (isUSD) {
          hint.innerText = "US Stocks: ‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÑ‡∏î‡πâ (‡πÄ‡∏ä‡πà‡∏ô 0.1, 1.5 ‡∏´‡∏∏‡πâ‡∏ô)";
      } else {
          hint.innerText = "Thai Stocks: ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° (Board Lot 100)";
      }
      display.classList.add('d-none');
    }
    calculate();
  }
  
  // Safety check
  function validateMaxOrders() {
      const el = document.getElementById('orderCount');
      if (el.value > 200) el.value = 200;
      if (el.value < 1) el.value = 1;
      calculate();
  }

  function generateShares(strategy, startShare, count, isUSD, useBoardLot) {
      let shares = [];
      
      function getFib(n) {
          if (n <= 1) return 1;
          let a = 1, b = 1;
          for (let i = 2; i <= n; i++) {
              let temp = a + b;
              a = b;
              b = temp;
          }
          return b;
      }
      
      // Helper to round based on rules
      function roundVol(v) {
          if (isUSD) return v; // No rounding for USD
          if (useBoardLot) {
              // Round to nearest 100 (Floor preference for safety)
              // If < 100, keep as is? Or force 100? Let's use standard floor 100
              // Actually for Martingale, we might want to round UP or Nearest?
              // Let's use round to nearest 100 for better distribution, but floor is safer for budget.
              // Logic: Math.floor(v / 100) * 100
              let r = Math.floor(v / 100) * 100;
              return r === 0 ? 100 : r; // Ensure at least 100 if calculated > 0 but < 100
          }
          return Math.floor(v); // Standard Integer
      }

      for (let i = 0; i < count; i++) {
          let vol = 0;
          let rawVol = 0;
          
          if (strategy === 'fixed') {
              rawVol = startShare;
          } else if (strategy === 'martingale') {
              rawVol = startShare * Math.pow(2, i);
          } else if (strategy === 'soft') {
              if (i === 0) rawVol = startShare;
              else rawVol = shares[i-1] * 1.5;
          } else if (strategy === 'linear') {
              rawVol = startShare * (i + 1);
          } else if (strategy === 'fibonacci') {
              rawVol = getFib(i) * startShare;
          }
          
          // Apply rounding logic to every step (except first one if fixed by input)
          // Actually, apply to all to be safe consistent
          vol = roundVol(rawVol);
          shares.push(vol);
      }
      return shares;
  }

  function calculatePortfolio(sharesArray, priceStep, startPrice) {
      let totalShares = 0;
      let totalCost = 0;     
      let totalDrawdown = 0; 
      let details = [];

      const maxDropDistance = sharesArray.length * priceStep; 
      const floorPrice = startPrice - maxDropDistance; 

      for (let i = 0; i < sharesArray.length; i++) {
          let vol = sharesArray[i];
          let distance = i * priceStep; 
          let entryPrice = startPrice - distance; 

          if (entryPrice < 0) entryPrice = 0;

          let cost = vol * entryPrice;
          let actualFloor = floorPrice < 0 ? 0 : floorPrice;
          let currentDrawdown = (actualFloor - entryPrice) * vol;

          totalShares += vol;
          totalCost += cost;
          totalDrawdown += currentDrawdown;

          details.push({
              orderNo: i + 1,
              entryPrice: entryPrice,
              volume: vol,
              distanceFromTop: distance,
              cost: cost,
              unrealizedPL: currentDrawdown
          });
      }

      let avgPrice = totalShares > 0 ? totalCost / totalShares : 0;

      return {
          totalShares,
          totalCost, 
          totalDrawdown,
          avgPrice,
          details
      };
  }

  function calculate() {
      const isUSD = document.getElementById('currUSD').checked;
      const useBoardLot = document.getElementById('useBoardLot').checked && !isUSD;

      const startPrice = parseFloat(document.getElementById('startPrice').value) || 0;
      let orderCount = parseInt(document.getElementById('orderCount').value) || 0;
      if (orderCount > 200) orderCount = 200; // Enforce limit
      
      const priceStep = parseFloat(document.getElementById('priceStep').value) || 0;
      const strategy = document.getElementById('strategy').value;
      
      let startInputVal = parseFloat(document.getElementById('startInput').value) || 0;
      const isBudgetMode = document.getElementById('modeBudget').checked;
      let startVol = 0;

      if (isBudgetMode) {
        if (startPrice > 0) {
            if (isUSD) {
                startVol = startInputVal / startPrice;
            } else {
                let rawShares = startInputVal / startPrice;
                if (useBoardLot) {
                    startVol = Math.floor(rawShares / 100) * 100;
                    if (startVol === 0 && rawShares > 0) startVol = 0; // If budget too low for 100 shares
                } else {
                    startVol = Math.floor(rawShares);
                }
            }
        }
        const displayVal = isUSD 
            ? startVol.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 4}) 
            : startVol.toLocaleString();
        document.getElementById('calculatedShares').innerText = displayVal;
      } else {
        startVol = isUSD ? parseFloat(startInputVal) : parseInt(startInputVal);
      }

      const sharesArray = generateShares(strategy, startVol, orderCount, isUSD, useBoardLot);
      const result = calculatePortfolio(sharesArray, priceStep, startPrice);

      const shareFormatOpts = isUSD ? {minimumFractionDigits: 2, maximumFractionDigits: 4} : {maximumFractionDigits: 0};
      const currencyFormatOpts = {minimumFractionDigits: 2, maximumFractionDigits: 2};
      
      document.getElementById('sumShares').innerText = result.totalShares.toLocaleString(undefined, shareFormatOpts);
      document.getElementById('totalCost').innerText = result.totalCost.toLocaleString(undefined, currencyFormatOpts);
      document.getElementById('avgPrice').innerText = result.avgPrice.toFixed(2);
      document.getElementById('maxDD').innerText = result.totalDrawdown.toLocaleString(undefined, currencyFormatOpts);

      const tbody = document.getElementById('resultTable');
      
      // OPTIMIZATION: Build HTML string first
      let htmlBuffer = '';
      result.details.forEach(item => {
          let priceClass = item.entryPrice <= 0 ? 'val-negative fw-bold' : '';
          let priceText = item.entryPrice <= 0 ? '0.00 (Out)' : item.entryPrice.toFixed(2);

          htmlBuffer += `<tr>
              <td><span class="badge bg-secondary rounded-pill bg-opacity-10 text-secondary border border-secondary border-opacity-25">${item.orderNo}</span></td>
              <td class="${priceClass}">${priceText}</td>
              <td class="text-muted small">-${item.distanceFromTop.toFixed(2)}</td>
              <td class="fw-bold" style="color: var(--color-primary);">${item.volume.toLocaleString(undefined, shareFormatOpts)}</td>
              <td>${item.cost.toLocaleString(undefined, currencyFormatOpts)}</td>
              <td class="val-negative fw-bold">${item.unrealizedPL.toLocaleString(undefined, currencyFormatOpts)}</td>
          </tr>`;
      });
      tbody.innerHTML = htmlBuffer;
  }
</script>

</body>
</html>
